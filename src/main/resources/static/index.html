<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>IntelliVault AI</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* èŠå¤©åŒºåŸŸ */
        #chat-box { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #fff; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 15px; max-width: 80%; line-height: 1.5; }
        .user { background: #007bff; color: white; margin-left: auto; text-align: right; }
        .ai { background: #f1f1f1; color: #333; margin-right: auto; }

        /* è¾“å…¥åŒºåŸŸ */
        .input-group { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; outline: none; }
        button { padding: 12px 25px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; }

        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #upload-status { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ¦ IntelliVault <span style="font-size:0.5em; color:#999">Private Knowledge Base</span></h2>

    <div class="upload-section">
        <input type="file" id="fileInput">
        <button onclick="uploadFile()">ä¸Šä¼ æ–‡æ¡£</button>
        <span id="upload-status"></span>
    </div>

    <div id="chat-box">
        <div class="message ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„çŸ¥è¯†åº“åŠ©æ‰‹ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ</div>
    </div>

    <div class="input-group">
        <input type="text" id="query" placeholder="è¾“å…¥é—®é¢˜..." onkeypress="handleEnter(event)">
        <button onclick="sendQuery()" id="sendBtn">å‘é€</button>
    </div>
</div>

<script>
    const userId = "user_" + Math.random().toString(36).substr(2, 9); // éšæœºç”Ÿæˆä¸ª ID æ¨¡æ‹Ÿå¤šç”¨æˆ·

    // 1. æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files[0]) return alert("è¯·é€‰æ‹©æ–‡ä»¶");

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        const status = document.getElementById('upload-status');
        status.innerText = "ä¸Šä¼ ä¸­...";

        try {
            const res = await fetch('/api/documents/upload', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            if (res.ok) {
                status.innerText = "âœ… " + data.message;
                status.style.color = "green";
            } else {
                throw new Error(data.message || "ä¸Šä¼ å¤±è´¥");
            }
        } catch (e) {
            status.innerText = "âŒ " + e.message;
            status.style.color = "red";
        }
    }

    // 2. å‘é€æ¶ˆæ¯é€»è¾‘ (æµå¼è¯»å–)
    async function sendQuery() {
        const input = document.getElementById('query');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();
        if (!text) return;

        // UI æ›´æ–°
        appendMessage(text, 'user');
        input.value = '';
        btn.disabled = true;

        // åˆ›å»º AI æ¶ˆæ¯æ°”æ³¡å ä½
        const aiMsgDiv = appendMessage("Thinking...", 'ai');
        let fullResponse = "";

        try {
            // å‘èµ·æµå¼è¯·æ±‚
            const response = await fetch(`/chat/stream?query=${encodeURIComponent(text)}&userId=${userId}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            aiMsgDiv.innerText = ""; // æ¸…ç©º Thinking

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                fullResponse += chunk;
                aiMsgDiv.innerText += chunk; // æ‰“å­—æœºæ•ˆæœ

                // æ»šåŠ¨åˆ°åº•éƒ¨
                const chatBox = document.getElementById('chat-box');
                chatBox.scrollTop = chatBox.scrollHeight;
            }

        } catch (e) {
            aiMsgDiv.innerText += "\n[Error: è¿æ¥æ–­å¼€]";
        } finally {
            btn.disabled = false;
        }
    }

    function appendMessage(text, type) {
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.innerText = text;
        document.getElementById('chat-box').appendChild(div);
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendQuery();
    }
</script>
</body>
</html>